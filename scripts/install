#/bin/sh
# Dotfiles Install Script
# Parameters:
# - none: install everything
# - BREW: install some brew dependencies
# - NVIM: set up `dein` and ini file
# - TMUX: set up tmuxrc file
# - VIFM: set up vifmrc file
# - GIT: set up git default config
# - HTOP: set up default htop file
# - OHMYZSH: install oh-my-zsh
# - PLUGINS: install oh my zsh req plugins
# - POWERLEVEL: install powerlevel 10k theme
# - AMETHYST: install & set up amethyst tiling window manager
# - ALACRITTY: install & set up the alacritty terminal emulator
# - ZSH: setup zsh as default shell

# Color definitions
black='\033[0;30m'
red='\033[0;31m'
green='\033[0;32m'
yellow='\033[0;33m'
blue='\033[0;34m'
purple='\033[0;35m'
cyan='\033[0;36m'
white='\033[0;37m'

# Define helpful variables
OH_MY_ZSH_DIR=$HOME/.oh-my-zsh
PLUGIN_DIR=$OH_MY_ZSH_DIR/custom/plugins
THEMES_DIR=$OH_MY_ZSH_DIR/custom/themes
GH_URL=https://github.com

# Log utils
function log_info() { echo "${cyan}$@${white}"; }
function log_success() { echo "${green}$@${white}"; }

# Function to safely link files
function safe_ln() {
    mv $2 $2.bak.$(date +%s)
    ln -s $1 $2
}

#   CHECK PARAMS  #
# --------------- #
[[ $# -eq 0 ]] && log_info ">>> No arguments supplied: Performing full instalation <<<"

#       BREW      #
# --------------- #

# Install dependencies
if [[ "$*" == *BREW* ]] || [[ $# -eq 0 ]]; then
    log_info ">>> BREW: Install dependencies <<<"
    brew update
    while read p; do
      brew install "$p"
    done <~/.dotfiles/requirements/brew-requirements.txt
fi

#       NVIM      #
# --------------- #

if [[ "$*" == *NVIM* ]] || [[ $# -eq 0 ]]; then

    # Install `dein`
    log_info ">>> NVIM: Install dein <<<"
    curl https://raw.githubusercontent.com/Shougo/dein.vim/master/bin/installer.sh \
        > dein_installer.sh \
        2> /dev/null
    sh ./dein_installer.sh ~/.dotfiles/dein > /dev/null
    rm dein_installer.sh

    # Setup ini file
    log_info ">>> NVIM: Setup rc file <<<"
    mkdir -p ~/.config/nvim
    mv ~/.config/nvim/init.vim ~/.config/nvim/init.vim.old &> /dev/null
    echo "source ~/.dotfiles/vimrc"  > ~/.config/nvim/init.vim

    # Prompt success
    log_success ">>> NVIM: Setup success <<<"
    log_info "Remember to run dein#install() when running vim for the first time"
fi

#       TMUX      #
# --------------- #

if [[ "$*" == *TMUX* ]] || [[ $# -eq 0 ]]; then
    # Link config file
    safe_ln ~/.dotfiles/tmux.conf ~/.tmux.conf
    log_success ">>> TMUX: Setup success <<<"
fi

#       VIFM      #
# --------------- #

if [[ "$*" == *VIFM* ]] || [[ $# -eq 0 ]]; then

    # Create dirs
    mkdir -p ~/.config/vifm
    mkdir -p ~/.config/vifm/colors

    # Setup config file
    echo "source ~/.dotfiles/vifmrc.vim"  > ~/.config/vifm/vifmrc
    cp ~/..dotfiles/zenburn.vifm ~/.config/vifm/colors/zenburn.vifm

    # Success prompt
    log_success ">>> VIFM: Setup success <<<"
fi

#       GIT       #
# --------------- #


if [[ "$*" == *GIT* ]] || [[ $# -eq 0 ]]; then
    # Link config file
    safe_ln ~/.dotfiles/git-template/gitconfig.global ~/.gitconfig
    log_success ">>> GIT: Setup success <<<"
fi

#       HTOP      #
# --------------- #

if [[ "$*" == *HTOP* ]] || [[ $# -eq 0 ]]; then
    # Create config dir
    mkdir -p ~/.config/htop

    # Link config file
    safe_ln ~/.dotfiles/htoprc ~/.config/htop/htoprc
    log_success ">>> HTOP: Setup success <<<"
fi

#       ZSH       #
# --------------- #


if [[ "$*" == *OHMYZSH* ]] || [[ $# -eq 0 ]]; then
    # Install Oh My Zsh
    log_info ">>> ZSH: Install Oh-my-zsh <<<"
    wget $GH_URL/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | zsh
    safe_ln ~/.dotfiles/zshrc ~/.zshrc
fi

if [[ "$*" == *PLUGINS* ]] || [[ $# -eq 0 ]]; then
    # Install extra plugins
    log_info ">>> ZSH: Install Oh-my-zsh plugins <<<"
    while read plugin; do
      gh_path=$(echo $plugin | cut -d ' ' -f 1)
      dst_path=$(echo $plugin | cut -d ' ' -f 2)
      git clone --depth=1 $GH_URL/$gh_path $PLUGIN_DIR/$dst_path
    done <~/.dotfiles/requirements/zsh-plugins.txt
fi

if [[ "$*" == *POWERLEVEL* ]] || [[ $# -eq 0 ]]; then
    # Install PowerLevel10K
    log_info ">>> ZSH: Install Oh-my-zsh PowerLevel10K <<<"
    git clone --depth=1 \
        $GH_URL/romkatv/powerlevel10k.git \
        $THEMES_DIR/powerlevel10k
fi

if [[ "$*" == *AMETHYST* ]] || [[ $# -eq 0 ]]; then
    # Install amethyst
    brew install --cask amethyst
    # Setup config file
    safe_ln ~/.dotfiles/amethyst.json ~/.amethyst
    log_success ">>> AMETHYST: Setup success <<<"
fi

if [[ "$*" == *ALACRITTY* ]] || [[ $# -eq 0 ]]; then
    # Install alacritty
    brew install alacritty
    # Setup rc
    safe_ln ~/.dotfiles/alacritty.yml ~/.alacritty.yml
    log_success ">>> ALACRITTY: Setup success <<<"
fi

if [[ "$*" == *ZSH* ]] || [[ $# -eq 0 ]]; then
    # Set Zsh as default shell
    log_info ">>> ZSH: Setup default shell <<<"
    chsh -s $(which zsh)
fi
