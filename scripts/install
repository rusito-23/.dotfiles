#!/bin/sh
# Dotfiles Install Script
# {{{ Parameters:
# - none: install everything
# - BREW: install some brew dependencies
# - NVIM: set up `dein` and ini file
# - TMUX: set up tmuxrc file
# - GIT: set up git default config
# - HTOP: set up default htop file
# - OHMYZSH: install oh-my-zsh
# - PLUGINS: install oh my zsh req plugins
# - POWERLEVEL: install powerlevel 10k theme
# - FZF: install and set up fzf
# - RANGER: install and set up the Ranger terminal file manager
# - YABAI: install & set up Yabai tiling window manager
# - ALACRITTY: install & set up the alacritty terminal emulator
# - ESPANSO: set up the espanso daemon
# - ZSH: setup zsh as default shell
# }}}

# {{{ Inits

# Load script utils
source ~/.dotfiles/scripts/utils

# Define helpful variables
OH_MY_ZSH_DIR=$HOME/.oh-my-zsh
PLUGIN_DIR=$OH_MY_ZSH_DIR/custom/plugins
THEMES_DIR=$OH_MY_ZSH_DIR/custom/themes
GH_URL=https://github.com

[[ $# -eq 0 ]] && log_info ">>> No arguments supplied: Performing full instalation <<<"

# }}}

# {{{  Installl Brew Dependencies

if [[ "$*" == *BREW* ]] || [[ $# -eq 0 ]]; then
    log_info ">>> BREW: Install dependencies <<<"
    # Update brew
    brew update
    # Install brew dependencies
    while read p; do
      brew install "$p"
    done <~/.dotfiles/requirements/brew-reqs.txt
    # Install cask dependencies
    while read p; do
      brew install cask "$p"
    done <~/.dotfiles/requirements/cask-reqs.txt
fi

# }}}

# {{{ Set up nvim

if [[ "$*" == *NVIM* ]] || [[ $# -eq 0 ]]; then
    # Setup ini file
    log_info ">>> NVIM: Setup config folder <<<"
    mv ~/.config/nvim ~/.config/nvim.old &> /dev/null
    ln -s ~/.dotfiles/nvim ~/.config/nvim

    # Prompt success
    log_success ">>> NVIM: Setup success <<<"
    log_info "Remember to run dein#install() when running vim for the first time"
fi

# }}}

# {{{ Set up Tmux

if [[ "$*" == *TMUX* ]] || [[ $# -eq 0 ]]; then
    # Link config file
    safe_ln ~/.dotfiles/tmux.conf ~/.tmux.conf
    log_success ">>> TMUX: Setup success <<<"
fi

# }}}

# {{{ Set up Git

if [[ "$*" == *GIT* ]] || [[ $# -eq 0 ]]; then
    # Link config file
    safe_ln ~/.dotfiles/git-template/gitconfig.global ~/.gitconfig
    log_success ">>> GIT: Setup success <<<"
fi

# }}}

# {{{ Setup Htop

if [[ "$*" == *HTOP* ]] || [[ $# -eq 0 ]]; then
    # Create config dir
    mkdir -p ~/.config/htop

    # Link config file
    safe_ln ~/.dotfiles/htoprc ~/.config/htop/htoprc
    log_success ">>> HTOP: Setup success <<<"
fi

# }}}

# {{{ Set up Zsh

if [[ "$*" == *OHMYZSH* ]] || [[ $# -eq 0 ]]; then
    # Install Oh My Zsh
    log_info ">>> ZSH: Install Oh-my-zsh <<<"
    wget $GH_URL/robbyrussell/oh-my-zsh/raw/master/tools/install.sh -O - | zsh
    safe_ln ~/.dotfiles/zshrc ~/.zshrc
fi

if [[ "$*" == *PLUGINS* ]] || [[ $# -eq 0 ]]; then
    # Install extra plugins
    log_info ">>> ZSH: Install Oh-my-zsh plugins <<<"
    while read plugin; do
      gh_path=$(echo $plugin | cut -d ' ' -f 1)
      dst_path=$(echo $plugin | cut -d ' ' -f 2)
      git clone --depth=1 $GH_URL/$gh_path $PLUGIN_DIR/$dst_path
    done <~/.dotfiles/requirements/zsh-plugins.txt
fi

if [[ "$*" == *POWERLEVEL* ]] || [[ $# -eq 0 ]]; then
    # Install PowerLevel10K
    log_info ">>> ZSH: Install Oh-my-zsh PowerLevel10K <<<"
    git clone --depth=1 \
        $GH_URL/romkatv/powerlevel10k.git \
        $THEMES_DIR/powerlevel10k
fi

# }}}

# {{{ Set up Fzf

if [[ "$*" == *FZF* ]] || [[ $# -eq 0 ]]; then
    # Install Fzf
    log_info ">>> Install Fzf <<<"
    brew install fzf

    # Install key bindings and completion
    $(brew --prefix)/opt/fzf/install
fi

# }}}

# {{{ Set up Ranger

if [[ "$*" == *RANGER* ]] || [[ $# -eq 0 ]]; then
    # Install Ranger
    log_info ">>> Install Ranger <<<"
    brew install ranger

    # Install config file
    mkdir -p ~/.config/ranger
    safe_ln ~/.dotfiles/ranger ~/.config/ranger
fi

# }}}

# {{{ Set up Yabai

if [[ "$*" == *YABAI* ]] || [[ $# -eq 0 ]]; then
    # Install yabai & skhdrc
    brew install koekeishiya/formulae/yabai
    brew install koekeishiya/formulae/skhd

    # load yabai sa
    sudo yabai --load-sa

    # start all services
    brew services start yabai
    brew services start skhd

    # Setup config files
    safe_ln ~/.dotfiles/yabairc ~/.yabairc
    safe_ln ~/.dotfiles/skhdrc ~/.skhdrc
    log_success ">>> YABAI: Setup success <<<"
fi

# }}}

# {{{ Set up Alacritty

if [[ "$*" == *ALACRITTY* ]] || [[ $# -eq 0 ]]; then
    # Install alacritty
    brew install alacritty
    # Setup rc
    safe_ln ~/.dotfiles/alacritty.yml ~/.alacritty.yml
    log_success ">>> ALACRITTY: Setup success <<<"
fi

# }}}

# {{{ Set up Espanso

if [[ "$*" == *ESPANSO* ]] || [[ $# -eq 0 ]]; then
    # Install
    brew tap federico-terzi/espanso
    brew install espanso
    espanso register
    # Setup rc
    ln -s ~/.dotfiles/espansorc ~/Library/Preferences/espanso/user/espansorc.yml
    # Reload changes
    espanso restart
fi

# }}}

# {{{ Set up Zsh as default shell

if [[ "$*" == *ZSH* ]] || [[ $# -eq 0 ]]; then
    # Set Zsh as default shell
    log_info ">>> ZSH: Setup default shell <<<"
    chsh -s $(which zsh)
fi

# }}}
